 NAQ Codebase Refactoring Plan                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                         
Current State Analysis                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                         
The NAQ codebase has a partially implemented event-driven system but needs significant refactoring to fully integrate and optimize it:                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                         
‚úÖ Completed Components                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                         
- Event Models: JobEvent, WorkerEvent, JobEventType, WorkerEventType classes in models.py                                                                                                                                                                                                                
- Event Storage: NATSJobEventStorage and BaseEventStorage interfaces                                                                                                                                                                                                                                     
- Event Logger: AsyncJobEventLogger with batching and async flushing                                                                                                                                                                                                                                     
- Event Processor: AsyncJobEventProcessor for real-time event handling                                                                                                                                                                                                                                   
- CLI Commands: Basic event monitoring commands exist                                                                                                                                                                                                                                                    
- Configuration: Environment variable support for event system                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                         
‚ùå Missing/Incomplete Areas                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                         
1. Event Integration: Not fully integrated into Worker, Queue, and Scheduler                                                                                                                                                                                                                             
2. CLI Commands: Missing comprehensive event monitoring commands documented in the API                                                                                                                                                                                                                   
3. Error Handling: Event logging failures could impact job processing                                                                                                                                                                                                                                    
4. Performance Optimization: Event logging not optimally configured for production                                                                                                                                                                                                                       
5. Testing Integration: Event system needs proper test coverage                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                         
---                                                                                                                                                                                                                                                                                                      
üéØ Phase 1: Core Integration (Priority: Critical)                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                         
1.1 Worker Integration Enhancements                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                         
- Integrate Event Logging: Ensure all job lifecycle events are logged in worker.py                                                                                                                                                                                                                       
- Worker Event Logging: Add comprehensive worker status events (started, stopped, heartbeat, errors)                                                                                                                                                                                                     
- Performance Optimization: Optimize event logging to not impact job processing                                                                                                                                                                                                                          
- Error Handling: Ensure event logging failures don't crash workers                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                         
1.2 Queue Integration Enhancements                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                         
- Job Enqueue Events: Log all job enqueueing, scheduling events in queue.py                                                                                                                                                                                                                              
- Schedule Management Events: Log schedule operations (pause, resume, cancel, modify)                                                                                                                                                                                                                    
- Batch Event Logging: Optimize for high-throughput job enqueueing scenarios                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                                                         
1.3 Scheduler Integration Enhancements                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                         
- Schedule Trigger Events: Log when scheduled jobs are moved to active queues                                                                                                                                                                                                                            
- Scheduler Lifecycle Events: Log scheduler start/stop, leader election events                                                                                                                                                                                                                           
- Schedule Management: Ensure all schedule operations emit proper events                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                         
---                                                                                                                                                                                                                                                                                                      
üéØ Phase 2: CLI Enhancement (Priority: High)                                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                                                         
2.1 Complete Event Monitoring Commands                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                         
- naq events: Real-time event streaming with filtering                                                                                                                                                                                                                                                   
- naq event-history: Historical event queries for specific jobs                                                                                                                                                                                                                                          
- naq event-stats: System-wide event analytics and statistics                                                                                                                                                                                                                                            
- naq worker-events: Worker-specific event monitoring                                                                                                                                                                                                                                                    
- Rich Output: Enhanced table formatting, colors, and real-time updates                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                         
2.2 Event System Management Commands                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                         
- naq events-status: Show event system health and configuration                                                                                                                                                                                                                                          
- naq events-cleanup: Manual event stream cleanup and maintenance                                                                                                                                                                                                                                        
- Configuration Commands: Show/validate event system configuration                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                         
---                                                                                                                                                                                                                                                                                                      
üéØ Phase 3: Performance & Production Optimization (Priority: High)                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                         
3.1 Event System Performance                                                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                                                         
- Batching Optimization: Tune default batch sizes and flush intervals                                                                                                                                                                                                                                    
- Memory Management: Implement proper buffer limits and cleanup                                                                                                                                                                                                                                          
- Connection Pooling: Optimize NATS connections for event logging                                                                                                                                                                                                                                        
- Background Processing: Ensure event I/O never blocks job execution                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                         
3.2 Production Configuration                                                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                                                         
- Environment Variable Completeness: Add all documented environment variables                                                                                                                                                                                                                            
- Production Defaults: Optimize default settings for production use                                                                                                                                                                                                                                      
- Resource Management: Proper cleanup and connection management                                                                                                                                                                                                                                          
- Error Recovery: Robust error handling and automatic reconnection                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                         
3.3 Event Stream Management                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                         
- Stream Configuration: Proper JetStream stream setup with retention policies                                                                                                                                                                                                                            
- Subject Optimization: Efficient NATS subject structure for filtering                                                                                                                                                                                                                                   
- Storage Management: Configurable retention and cleanup policies                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                         
---                                                                                                                                                                                                                                                                                                      
üéØ Phase 4: Code Quality & Maintenance (Priority: Medium)                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                         
4.1 Code Organization                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                         
- Type Hints: Complete type annotations across all event-related code                                                                                                                                                                                                                                    
- Documentation: Comprehensive docstrings matching the API documentation                                                                                                                                                                                                                                 
- Code Consistency: Consistent error handling and logging patterns                                                                                                                                                                                                                                       
- Import Optimization: Clean up imports and circular dependency issues                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                         
4.2 Testing Infrastructure                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                         
- Unit Tests: Comprehensive test coverage for event system components                                                                                                                                                                                                                                    
- Integration Tests: End-to-end event logging and processing tests                                                                                                                                                                                                                                       
- Performance Tests: Event system performance and load testing                                                                                                                                                                                                                                           
- Mock Infrastructure: Proper mocking for NATS dependencies in tests                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                         
4.3 Error Handling & Logging                                                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                                                         
- Graceful Degradation: Event system failures shouldn't impact core functionality                                                                                                                                                                                                                        
- Diagnostic Logging: Proper logging for event system debugging                                                                                                                                                                                                                                          
- Exception Handling: Comprehensive exception handling in event components                                                                                                                                                                                                                               
- Health Checks: Event system health monitoring and diagnostics                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                         
---                                                                                                                                                                                                                                                                                                      
üéØ Phase 5: Advanced Features (Priority: Low)                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                         
5.1 Event Analytics                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                         
- Metrics Collection: Built-in metrics for event rates, latencies, failures                                                                                                                                                                                                                              
- Performance Analysis: Job execution time analysis and trending                                                                                                                                                                                                                                         
- Alerting Integration: Support for external monitoring systems                                                                                                                                                                                                                                          
- Custom Event Processing: Framework for user-defined event processors                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                         
5.2 Event System Extensions                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                         
- Event Filtering: Advanced filtering capabilities for event queries                                                                                                                                                                                                                                     
- Event Aggregation: Real-time event aggregation and rollup                                                                                                                                                                                                                                              
- Event Replay: Ability to replay events for debugging/analysis                                                                                                                                                                                                                                          
- Event Export: Export capabilities for external analysis tools                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                         
---                                                                                                                                                                                                                                                                                                      
üìã Implementation Order & Dependencies                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                         
1. Phase 1 (Core Integration) - Must be completed first as foundation                                                                                                                                                                                                                                    
2. Phase 2 (CLI Enhancement) - Can be done in parallel with Phase 3                                                                                                                                                                                                                                      
3. Phase 3 (Performance) - Critical for production readiness                                                                                                                                                                                                                                             
4. Phase 4 (Code Quality) - Should be integrated throughout phases 1-3                                                                                                                                                                                                                                   
5. Phase 5 (Advanced Features) - Future enhancements                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                         
‚è± Estimated Timeline                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                         
- Phase 1: 2-3 days (critical path)                                                                                                                                                                                                                                                                      
- Phase 2: 1-2 days (can parallel with Phase 3)                                                                                                                                                                                                                                                          
- Phase 3: 2-3 days (performance critical)                                                                                                                                                                                                                                                               
- Phase 4: 1-2 days (ongoing throughout)                                                                                                                                                                                                                                                                 
- Phase 5: 1-2 days (optional enhancements)                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                         
Total: 5-7 days for production-ready event system                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                         
üéØ Success Criteria                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                         
- All job lifecycle events properly logged                                                                                                                                                                                                                                                               
- Real-time event monitoring via CLI works perfectly                                                                                                                                                                                                                                                     
- Event system doesn't impact job processing performance                                                                                                                                                                                                                                                 
- Comprehensive event analytics and debugging capabilities                                                                                                                                                                                                                                               
- Production-ready configuration and error handling                                                                                                                                                                                                                                                      
- Complete test coverage for event system     